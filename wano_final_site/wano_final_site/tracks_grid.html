<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WANO TERMINAL — Track Archive</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    html, body { height:100%; background:#000; color:#fff; font-family:'Courier New',monospace; overflow-x:hidden; }

    /* ── STICKY GLOBAL PLAYER ── */
    #global-player {
      position:fixed;
      bottom:0; left:0; right:0;
      background:#000;
      border-top:1px solid #00ff00;
      z-index:100;
      padding:0.8rem 2rem;
      display:none;
      align-items:center;
      gap:1.5rem;
    }
    #global-player.visible { display:flex; }

    .gp-info { flex:0 0 220px; overflow:hidden; }
    .gp-title {
      font-size:0.85rem;
      color:#00ff00;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .gp-meta { font-size:0.75rem; opacity:0.5; margin-top:0.2rem; }

    .gp-controls { display:flex; align-items:center; gap:0.8rem; }
    .gp-btn {
      background:none;
      border:1px solid #333;
      color:#fff;
      font-family:inherit;
      font-size:0.9rem;
      padding:0.4rem 0.7rem;
      cursor:pointer;
      transition:all 0.15s;
    }
    .gp-btn:hover { border-color:#00ff00; color:#00ff00; }
    .gp-btn.playing { border-color:#00ff00; color:#00ff00; background:#001100; }

    .gp-progress-wrap {
      flex:1;
      display:flex;
      align-items:center;
      gap:0.8rem;
    }
    .gp-time { font-size:0.75rem; opacity:0.6; flex:0 0 80px; text-align:right; white-space:nowrap; }
    .gp-bar-track {
      flex:1;
      height:3px;
      background:#222;
      cursor:pointer;
      position:relative;
    }
    .gp-bar-fill {
      height:100%;
      background:#00ff00;
      width:0%;
      transition:width 0.1s linear;
      pointer-events:none;
    }
    .gp-bar-track:hover .gp-bar-fill { background:#00ff00; }

    .gp-vol-wrap { display:flex; align-items:center; gap:0.5rem; font-size:0.75rem; opacity:0.6; }
    .gp-vol {
      -webkit-appearance:none;
      width:70px; height:3px;
      background:#222; cursor:pointer; outline:none;
    }
    .gp-vol::-webkit-slider-thumb {
      -webkit-appearance:none;
      width:10px; height:10px;
      background:#00ff00; border-radius:50%;
    }

    /* ── HEADER ── */
    .site-header {
      padding:1.5rem 2rem;
      border-bottom:1px solid #222;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
      flex-wrap:wrap;
      position:sticky; top:0; z-index:50;
      background:#000;
    }
    .site-header .brand { font-size:1rem; color:#00ff00; letter-spacing:0.05em; }
    .site-nav { display:flex; gap:1rem; }
    .site-nav a {
      color:#fff; text-decoration:none;
      font-size:0.85rem; opacity:0.6;
      border-bottom:1px solid transparent;
      padding-bottom:1px;
      transition:all 0.15s;
    }
    .site-nav a:hover, .site-nav a.active { opacity:1; border-color:#00ff00; color:#00ff00; }

    /* ── CONTROLS ── */
    .controls {
      padding:1rem 2rem;
      border-bottom:1px solid #1a1a1a;
      display:flex;
      gap:1rem;
      flex-wrap:wrap;
      align-items:center;
    }
    .search-box { flex:1; min-width:220px; }
    .search-box input {
      width:100%;
      background:#000;
      border:1px solid #222;
      color:#fff;
      padding:0.6rem 1rem;
      font-family:inherit;
      font-size:0.9rem;
      outline:none;
      transition:border-color 0.15s;
    }
    .search-box input:focus { border-color:#00ff00; }
    .search-box input::placeholder { color:#444; }

    .filters { display:flex; gap:0.4rem; flex-wrap:wrap; }
    .filter-btn {
      background:#000;
      border:1px solid #222;
      color:#666;
      padding:0.5rem 0.85rem;
      font-family:inherit;
      font-size:0.8rem;
      cursor:pointer;
      letter-spacing:0.05em;
      transition:all 0.15s;
    }
    .filter-btn:hover { border-color:#555; color:#ccc; }
    .filter-btn.active { border-color:#00ff00; color:#00ff00; background:#001100; }

    /* ── GRID ── */
    .grid {
      padding:1.5rem 2rem 6rem;
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(260px, 1fr));
      gap:1px;
      background:#111;
      max-width:1600px;
      margin:0 auto;
    }

    /* ── CARD ── */
    .card {
      background:#000;
      display:flex;
      flex-direction:column;
      transition:background 0.15s;
      cursor:default;
      position:relative;
    }
    .card:hover { background:#050f05; }
    .card.playing { background:#001400; }

    .card-art {
      height:100px;
      font-family:'Courier New',monospace;
      font-size:0.62rem;
      line-height:1.05;
      padding:0.4rem 0.6rem;
      overflow:hidden;
      background:#030903;
      position:relative;
    }
    .card-art pre {
      margin:0;
      white-space:pre;
      color:#00ff00;
      opacity:0.35;
      transition:opacity 0.2s;
    }
    .card:hover .card-art pre { opacity:0.55; }
    .card.playing .card-art pre { opacity:0.8; }

    /* Waveform animation overlay when playing */
    .card-art .wave {
      position:absolute;
      bottom:0; left:0; right:0;
      height:30px;
      display:none;
      align-items:flex-end;
      gap:2px;
      padding:0 6px 4px;
    }
    .card.playing .card-art .wave { display:flex; }
    .wave-bar {
      flex:1;
      background:#00ff00;
      opacity:0.7;
      border-radius:1px 1px 0 0;
      animation:wavebar 0.6s ease-in-out infinite alternate;
    }
    @keyframes wavebar {
      from { height:3px; }
      to { height:20px; }
    }

    .card-inner { padding:1rem; flex:1; display:flex; flex-direction:column; gap:0.6rem; }

    .card-number { font-size:0.75rem; color:#00ff00; opacity:0.6; }
    .card-title { font-size:0.95rem; line-height:1.3; color:#fff; }
    .card.playing .card-title { color:#00ff00; }

    .card-meta { font-size:0.75rem; opacity:0.4; display:flex; gap:0.5rem; }

    .card-tags { display:flex; gap:0.3rem; flex-wrap:wrap; }
    .tag {
      font-size:0.7rem;
      border:1px solid #1a1a1a;
      padding:0.15rem 0.4rem;
      color:#555;
    }

    .card-desc { font-size:0.8rem; opacity:0.55; line-height:1.4; flex:1; }

    .card-action { margin-top:auto; padding-top:0.6rem; }
    .play-btn {
      width:100%;
      background:#000;
      border:1px solid #1a1a1a;
      color:#555;
      padding:0.55rem;
      font-family:inherit;
      font-size:0.8rem;
      cursor:pointer;
      letter-spacing:0.05em;
      transition:all 0.15s;
    }
    .play-btn:hover:not(:disabled) { border-color:#00ff00; color:#00ff00; background:#001100; }
    .play-btn.active { border-color:#00ff00; color:#00ff00; background:#001400; }
    .play-btn:disabled { opacity:0.3; cursor:not-allowed; }

    /* ── EMPTY ── */
    .empty { padding:4rem 2rem; text-align:center; opacity:0.4; }

    /* ── SCROLLBAR ── */
    ::-webkit-scrollbar { width:4px; }
    ::-webkit-scrollbar-track { background:#000; }
    ::-webkit-scrollbar-thumb { background:#222; }
    ::-webkit-scrollbar-thumb:hover { background:#00ff00; }

    /* ── RESPONSIVE ── */
    @media (max-width:768px) {
      .site-header, .controls { padding:1rem; }
      .grid { padding:0 0 6rem; }
      .gp-vol-wrap { display:none; }
      .gp-info { flex:0 0 140px; }
      #global-player { padding:0.7rem 1rem; gap:0.8rem; }
    }
    @media (max-width:480px) {
      .grid { grid-template-columns:1fr 1fr; }
      .card-desc { display:none; }
      .gp-info { display:none; }
    }
  </style>
</head>
<body>

  <!-- GLOBAL PLAYER -->
  <div id="global-player">
    <div class="gp-info">
      <div class="gp-title" id="gp-title">—</div>
      <div class="gp-meta" id="gp-meta">—</div>
    </div>

    <div class="gp-controls">
      <button class="gp-btn" id="gp-prev" title="Précédent">◀◀</button>
      <button class="gp-btn" id="gp-play" title="Play/Pause">▶ PLAY</button>
      <button class="gp-btn" id="gp-next" title="Suivant">▶▶</button>
    </div>

    <div class="gp-progress-wrap">
      <div class="gp-time" id="gp-time">0:00 / 0:00</div>
      <div class="gp-bar-track" id="gp-bar">
        <div class="gp-bar-fill" id="gp-fill"></div>
      </div>
    </div>

    <div class="gp-vol-wrap">
      VOL
      <input type="range" class="gp-vol" id="gp-vol" min="0" max="1" step="0.01" value="1">
    </div>
  </div>

  <!-- HEADER -->
  <header class="site-header">
    <div class="brand">WANO TERMINAL — TRACK ARCHIVE</div>
    <nav class="site-nav">
      <a href="wano_final.html">← TERMINAL</a>
      <a href="tracks_grid.html" class="active">GRID</a>
    </nav>
  </header>

  <!-- CONTROLS -->
  <div class="controls">
    <div class="search-box">
      <input type="search" id="searchInput" placeholder="/ — search title, tag, year…" autocomplete="off">
    </div>
    <div class="filters" id="filters">
      <button class="filter-btn active" data-filter="all">ALL</button>
      <button class="filter-btn" data-filter="release">RELEASES</button>
      <button class="filter-btn" data-filter="live">LIVE</button>
      <button class="filter-btn" data-filter="unreleased">UNRELEASED</button>
      <button class="filter-btn" data-filter="mix">MIXES</button>
    </div>
  </div>

  <!-- GRID -->
  <div class="grid" id="grid"></div>
  <div class="empty" id="empty" style="display:none">[ NO TRACKS FOUND ]</div>

  <audio id="audio-engine" preload="none"></audio>

  <script>
    // ══════════════════════════════════════════
    //  TRACK DATA — replace src with your R2 URLs
    // ══════════════════════════════════════════
    const TRACKS = [
      { id:'w1',  title:'Ricardo Villalobos — 808 The Bassqueen', year:2024, type:'release',    tags:['minimal','techno'],      src:'https://pub-a27a87aee8d64445bd42afcc0ae8ed45.r2.dev/Ricardo_Villalobos-808_the_bassqueen(www.mp3vip.org).mp3',  desc:'Textures lumineuses et micro-variations rythmiques. Une ouverture cinétique.' },
      { id:'w2',  title:'Kirishima Live Excerpt',          year:2023, type:'live',       tags:['ambient','live'],        src:'',  desc:'Extrait capté lors d\'une performance minimaliste. Drones et résonances lentes.' },
      { id:'w3',  title:'Shogun Protocol (Unreleased v2)', year:2025, type:'unreleased', tags:['breaks','demo'],         src:'',  desc:'Ébauche nerveuse : kicks granuleux, hats tranchants, motif dissonant.' },
      { id:'w4',  title:'Citizen Étienne Tape A1',         year:2022, type:'mix',        tags:['cassette','lofi'],       src:'',  desc:'Sélection bande magnétique : souffle, wobble et saturation douce.' },
      { id:'w5',  title:'Wano Gate Opening',               year:2021, type:'release',    tags:['synth','cinematic'],     src:'',  desc:'Thème d\'ouverture, arpèges étagés et nappes larges.' },
      { id:'w6',  title:'Undersea Terminals',              year:2020, type:'release',    tags:['downtempo'],             src:'',  desc:'Groove sous-marin, basses molles et cloches métalliques.' },
      { id:'w7',  title:'Night Market Streams (Live)',     year:2024, type:'live',       tags:['modular'],               src:'',  desc:'Impro modulaire : séquences perlées et variations d\'attaque.' },
      { id:'w8',  title:'Green Phosphor Text',             year:2025, type:'unreleased', tags:['glitch'],                src:'',  desc:'Glitch calligraphique, ponctué de silences intentionnels.' },
      { id:'w9',  title:'Midnight Protocols',              year:2023, type:'release',    tags:['techno','industrial'],   src:'',  desc:'Séquences métalliques et réverbérations profondes. Hypnotique.' },
      { id:'w10', title:'Static Dreams Vol.2',             year:2024, type:'mix',        tags:['experimental','noise'],  src:'',  desc:'Collection de textures granulaires et accidents sonores.' },
      { id:'w11', title:'Basement Sessions 03',            year:2023, type:'live',       tags:['dub','techno'],          src:'', desc:'Live recording : delays spatiaux, kicks sourds, atmosphères sombres.' },
      { id:'w12', title:'Phantom Signals',                 year:2025, type:'unreleased', tags:['ambient','drone'],       src:'', desc:'Work in progress : transmissions fantômes et fréquences errantes.' },
    ];

    // ══════════════════════════════════════════
    //  STATE
    // ══════════════════════════════════════════
    let currentIndex = -1;   // index in TRACKS
    let visibleTracks = [];  // filtered subset
    let isPlaying = false;

    const audio    = document.getElementById('audio-engine');
    const player   = document.getElementById('global-player');
    const gpTitle  = document.getElementById('gp-title');
    const gpMeta   = document.getElementById('gp-meta');
    const gpPlay   = document.getElementById('gp-play');
    const gpPrev   = document.getElementById('gp-prev');
    const gpNext   = document.getElementById('gp-next');
    const gpFill   = document.getElementById('gp-fill');
    const gpBar    = document.getElementById('gp-bar');
    const gpTime   = document.getElementById('gp-time');
    const gpVol    = document.getElementById('gp-vol');
    const grid     = document.getElementById('grid');
    const emptyEl  = document.getElementById('empty');
    const search   = document.getElementById('searchInput');
    const filtersEl= document.getElementById('filters');

    let currentFilter = 'all';

    // ── ASCII ART GENERATOR ──
    function genArt(id, type) {
      const patterns = {
        release:    ['█','▓','▒','░'],
        live:       ['▀','▄','█','░'],
        unreleased: ['▓','▒','░',' '],
        mix:        ['■','□','▪','▫'],
      };
      const chars = patterns[type] || patterns.release;
      const seed = id.split('').reduce((a,c) => a + c.charCodeAt(0), 0);
      let art = '';
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 26; c++) art += chars[(seed + r*7 + c*3) % chars.length];
        art += '\n';
      }
      return art;
    }

    // ── WAVE BARS ──
    function makeWave(n = 12) {
      const div = document.createElement('div');
      div.className = 'wave';
      for (let i = 0; i < n; i++) {
        const b = document.createElement('div');
        b.className = 'wave-bar';
        b.style.animationDelay = (Math.random() * 0.5) + 's';
        b.style.animationDuration = (0.4 + Math.random() * 0.5) + 's';
        div.appendChild(b);
      }
      return div;
    }

    // ── FORMAT TIME ──
    function fmtTime(s) {
      if (!s || isNaN(s)) return '0:00';
      const m = Math.floor(s / 60);
      const sec = Math.floor(s % 60).toString().padStart(2,'0');
      return m + ':' + sec;
    }

    // ── CARD FACTORY ──
    function createCard(track, globalIdx) {
      const card = document.createElement('div');
      card.className = 'card';
      card.id = 'card-' + track.id;

      // Art
      const art = document.createElement('div');
      art.className = 'card-art';
      const pre = document.createElement('pre');
      pre.textContent = genArt(track.id, track.type);
      art.appendChild(pre);
      art.appendChild(makeWave());

      // Inner
      const inner = document.createElement('div');
      inner.className = 'card-inner';

      const num = document.createElement('div');
      num.className = 'card-number';
      num.textContent = '[' + String(globalIdx + 1).padStart(2,'0') + ']';

      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = track.title.toUpperCase();

      const meta = document.createElement('div');
      meta.className = 'card-meta';
      meta.textContent = track.year + ' · ' + track.type;

      const tags = document.createElement('div');
      tags.className = 'card-tags';
      track.tags.forEach(t => {
        const tg = document.createElement('span');
        tg.className = 'tag';
        tg.textContent = t;
        tags.appendChild(tg);
      });

      const desc = document.createElement('div');
      desc.className = 'card-desc';
      desc.textContent = track.desc || '';

      const action = document.createElement('div');
      action.className = 'card-action';

      const btn = document.createElement('button');
      btn.className = 'play-btn';
      btn.id = 'btn-' + track.id;
      btn.disabled = !track.src;
      btn.textContent = track.src ? '▶ PLAY' : '⊘ NO SOURCE';

      if (track.src) {
        btn.addEventListener('click', () => {
          if (currentIndex === globalIdx && isPlaying) {
            pauseAudio();
          } else {
            loadAndPlay(globalIdx);
          }
        });
      }

      action.appendChild(btn);
      inner.appendChild(num);
      inner.appendChild(title);
      inner.appendChild(meta);
      inner.appendChild(tags);
      inner.appendChild(desc);
      inner.appendChild(action);

      card.appendChild(art);
      card.appendChild(inner);

      return card;
    }

    // ── RENDER ──
    function render() {
      grid.innerHTML = '';
      const q = search.value.toLowerCase().trim();
      visibleTracks = TRACKS.filter(t => {
        const matchFilter = currentFilter === 'all' || t.type === currentFilter;
        const matchSearch = !q || t.title.toLowerCase().includes(q)
          || t.tags.some(tg => tg.includes(q))
          || String(t.year).includes(q);
        return matchFilter && matchSearch;
      });
      if (visibleTracks.length === 0) { emptyEl.style.display = 'block'; return; }
      emptyEl.style.display = 'none';
      visibleTracks.forEach(t => {
        const gi = TRACKS.indexOf(t);
        grid.appendChild(createCard(t, gi));
      });
      // Restore playing state visuals
      if (currentIndex >= 0) refreshCardStates();
    }

    // ── CARD VISUAL STATE ──
    function refreshCardStates() {
      document.querySelectorAll('.card').forEach(c => c.classList.remove('playing'));
      document.querySelectorAll('.play-btn').forEach(b => b.classList.remove('active'));
      if (currentIndex < 0) return;
      const t = TRACKS[currentIndex];
      const card = document.getElementById('card-' + t.id);
      const btn  = document.getElementById('btn-'  + t.id);
      if (card) card.classList.toggle('playing', isPlaying);
      if (btn)  {
        btn.classList.toggle('active', isPlaying);
        btn.textContent = isPlaying ? '⏸ PAUSE' : '▶ PLAY';
      }
    }

    // ── PLAYER ENGINE ──
    function loadAndPlay(idx) {
      currentIndex = idx;
      const t = TRACKS[idx];
      audio.src = t.src;
      audio.load();
      audio.play().then(() => {
        isPlaying = true;
        updatePlayerUI(t);
        refreshCardStates();
      }).catch(() => {});
    }

    function pauseAudio() {
      audio.pause();
    }

    function updatePlayerUI(t) {
      player.classList.add('visible');
      gpTitle.textContent = t.title;
      gpMeta.textContent  = t.year + ' · ' + t.type + ' · ' + t.tags.join(', ');
      gpPlay.textContent  = '⏸ PAUSE';
      gpPlay.classList.add('playing');
    }

    audio.addEventListener('play', () => {
      isPlaying = true;
      gpPlay.textContent = '⏸ PAUSE';
      gpPlay.classList.add('playing');
      refreshCardStates();
    });

    audio.addEventListener('pause', () => {
      isPlaying = false;
      gpPlay.textContent = '▶ PLAY';
      gpPlay.classList.remove('playing');
      refreshCardStates();
    });

    audio.addEventListener('ended', () => {
      // Autoplay next
      const nextIdx = getAdjacentIdx(1);
      if (nextIdx !== null) loadAndPlay(nextIdx);
    });

    audio.addEventListener('timeupdate', () => {
      if (!audio.duration) return;
      const pct = (audio.currentTime / audio.duration) * 100;
      gpFill.style.width = pct + '%';
      gpTime.textContent = fmtTime(audio.currentTime) + ' / ' + fmtTime(audio.duration);
    });

    // ── SEEK ──
    gpBar.addEventListener('click', (e) => {
      if (!audio.duration) return;
      const rect = gpBar.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      audio.currentTime = pct * audio.duration;
    });

    // ── VOLUME ──
    gpVol.addEventListener('input', () => { audio.volume = gpVol.value; });

    // ── CONTROLS ──
    gpPlay.addEventListener('click', () => {
      if (currentIndex < 0) return;
      if (isPlaying) audio.pause(); else audio.play();
    });

    function getAdjacentIdx(dir) {
      if (currentIndex < 0) return null;
      const withSrc = TRACKS.map((t,i) => ({t,i})).filter(x => x.t.src);
      const pos = withSrc.findIndex(x => x.i === currentIndex);
      if (pos < 0) return null;
      const next = pos + dir;
      if (next < 0 || next >= withSrc.length) return null;
      return withSrc[next].i;
    }

    gpPrev.addEventListener('click', () => {
      const idx = getAdjacentIdx(-1);
      if (idx !== null) loadAndPlay(idx);
    });
    gpNext.addEventListener('click', () => {
      const idx = getAdjacentIdx(1);
      if (idx !== null) loadAndPlay(idx);
    });

    // ── FILTERS & SEARCH ──
    filtersEl.addEventListener('click', (e) => {
      if (!e.target.classList.contains('filter-btn')) return;
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      currentFilter = e.target.dataset.filter;
      render();
    });
    search.addEventListener('input', render);

    // ── KEYBOARD ──
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== search) {
        e.preventDefault(); search.focus(); search.select();
      }
      if (e.key === ' ' && document.activeElement !== search) {
        e.preventDefault();
        if (currentIndex >= 0) { if (isPlaying) audio.pause(); else audio.play(); }
      }
      if (e.key === 'ArrowRight') { const i = getAdjacentIdx(1);  if (i !== null) loadAndPlay(i); }
      if (e.key === 'ArrowLeft')  { const i = getAdjacentIdx(-1); if (i !== null) loadAndPlay(i); }
    });

    // ── INIT ──
    render();
  </script>
</body>
</html>
